---
# tasks file for k3s

- name: Ensure "{{ k3s_ulb_dir }}" exists
  ansible.builtin.file:
    path: "{{ k3s_ulb_dir }}"
    state: directory

- name: Pull k3s images
  ansible.builtin.get_url:
    url: "{{ k3s_images }}"
    dest: "{{ k3s_ulb_dir }}/"
  when: false

- name: Pull k3s binary
  ansible.builtin.get_url:
    url: "{{ k3s_binary }}"
    dest: "{{ k3s_ulb_dir }}/"
    mode: 0755

- name: Ensure /root/k3s exists
  ansible.builtin.file:
    path: "{{ k3s_root_dir }}"
    state: directory

- name: Pull www.k3s.io to install.sh
  ansible.builtin.get_url:
    url: "{{ k3s_install }}"
    dest: "{{ k3s_root_dir }}/{{ k3s_install_file }}"
    mode: 0755

- name: Pull k3s RPM
  ansible.builtin.get_url:
    url: "{{ k3s_rpm }}"
    dest: "{{ k3s_root_dir }}/"

- name: Get RPM filename
  ansible.builtin.find:
    paths: "{{ k3s_root_dir }}"
    patterns: '*.rpm'
  register: k3s_rpm_file

- debug: "var=k3s_rpm_file"

- name: Install k3s from RPM
  ansible.builtin.package:
    name: "{{ item.path }}"
    state: present
    disable_gpg_check: "{{ k3s_disable_yum_gpg_check | default(omit) }}"
  with_items: "{{ k3s_rpm_file.files }}"

- name: Install k3s
  ansible.builtin.shell: "INSTALL_K3S_SKIP_DOWNLOAD=true {{ k3s_root_dir }}/{{ k3s_install_file }}"
